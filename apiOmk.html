<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>API Omeka S</title>

    <!-- CSS Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container my-4">
        
        <!-- Lecture des items -->
        <h3 class="mb-3">Afficher les items Omeka S</h3>

        <button id="btnGet" class="btn btn-success mb-3">
            Afficher les items Omeka S
        </button>

        <table id="resultat" class="table table-bordered table-striped table-hover">
            <thead>
                <tr>
                    <th>Titre</th>
                    <th>Texte</th>
                    <th>Résumé</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <!-- Envoyer un item -->
        <hr class="mt-5">
        <h3 class="mb-3">Créer un item dans Omeka S</h3>

        <div class="mb-3">
            <label for="titre">Titre</label>
            <input type="text" id="titre" class="form-control">
        </div>

        <div class="mb-3">
            <label for="texte">Texte</label>
            <textarea id="texte" class="form-control"></textarea>
        </div>

        <button id="btnEnvoyer" class="btn btn-success mb-3">
            Envoyer les données à Omeka S
        </button>

        <pre id="responseItem" class="bg-light p-3 border rounded"></pre>

        <!-- Envoyer un Audio -->
        <hr class="mt-5">
        <h3 class="mb-3">Enregistrer et envoyer un audio vers Omeka S</h3>

        <label class="mb-2">Nom de l’enregistrement :</label>
        <input id="nomAudio" type="text" placeholder="Ex : Ma voix" class="form-control mb-3"/>

        <div>
            <button id="btnRecord" class="btn btn-warning">Démarrer</button>
            <button id="btnStop" class="btn btn-secondary" disabled>Stop</button>
            <button id="btnSendAudio" class="btn btn-success" disabled>Envoyer</button>
        </div>

        <p id="audioStatus" class="mt-2"></p>
        <audio id="audioPreview" controls class="mt-3" style="display:none;"></audio>

        <pre id="responseAudio" class="bg-light mt-3 p-3 border rounded"></pre>
    </div>

    <script>
        // Configuration API
        const baseURL = "http://localhost/omk_thyp_25-26_clone/api/items";
        const key_identity = "dURgA6sfAT3VGheTS97xwZj983Cr33fv";
        const key_credential = "Z7QCZ2AM0G0wwNAwVuSGwZ4tbUYCr6gb";

    
        // ########################################
        // Lecture des items Omeka S
        // ########################################

        document.getElementById("btnGet").addEventListener("click", () => {
            const url = `${baseURL}?key_identity=${key_identity}&key_credential=${key_credential}`;
            fetch(url)
            .then(response => {
            if (!response.ok) throw new Error(`Erreur HTTP ${response.status}`);
                return response.json();
            })
            .then(data => {
                let chaine = "";
                data.forEach(item => {
                    const titre = item["dcterms:title"]?.[0]?.["@value"] || "(sans titre)";
                    const texte = item["dcterms:description"]?.[0]?.["@value"] || "(sans texte)";
                    const resume = item["dcterms:abstract"]?.[0]?.["@value"] || "(sans résumé)";
                    chaine += `
                        <tr>
                            <td>${titre}</td>
                            <td>${texte}</td>
                            <td>${resume}</td>
                        </tr>
                    `;
                });
                document.querySelector("#resultat tbody").innerHTML = chaine;
            })
            .catch(err => {
                document.getElementById("resultat").textContent =
                    "Erreur de lecture : " + err.message;
            });
        });
        

        // ########################################
        // Ajout d’un item dans Omeka S
        // ########################################

        document.getElementById("btnEnvoyer").addEventListener("click", () => {
            const titre = document.getElementById("titre").value.trim();
            const texte = document.getElementById("texte").value.trim();

            // Génération d’un résumé automatique (~50 mots)
            const mots = texte.split(/\s+/);
            const resume = mots.slice(0, 50).join(" ");

            const newItem = {
                "o:is_public": true,

                // Titre obligatoire
                "dcterms:title": [
                    {
                        "type": "literal",
                        "property_id": "auto",
                        "@value": titre
                    }
                ],

                // Texte
                "dcterms:description": [
                    {
                        "type": "literal",
                        "property_id": "auto",
                        "@value": texte
                    }
                ],

                // Résumé
                "dcterms:abstract": [
                    { 
                        "type": "literal",
                        "property_id": "auto",
                        "@value": resume
                    }
                ]
            };

            fetch(`${baseURL}?key_identity=${key_identity}&key_credential=${key_credential}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(newItem)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`Erreur HTTP ${response.status}: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                document.getElementById("responseItem").textContent =
                    "Item créé avec succès :\n" + JSON.stringify(data, null, 2);
            })
            .catch(err => {
                document.getElementById("responseItem").textContent =
                    "Erreur : " + err.message;
            });
        });


        // ########################################
        // Enregistrement audio
        // ########################################

        let mediaRecorder;
        let recordedChunks = [];
        let recordedBlob = null;

        const btnRecord = document.getElementById("btnRecord");
        const btnStop = document.getElementById("btnStop");
        const btnSendAudio = document.getElementById("btnSendAudio");
        const audioStatus = document.getElementById("audioStatus");
        const audioPreview = document.getElementById("audioPreview");
        const inputNom = document.getElementById("nomAudio");

        let mediaStream = null;

        btnRecord.addEventListener("click", async () => {
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });

                recordedChunks = [];
                recordedBlob = null;

                mediaRecorder = new MediaRecorder(mediaStream);

                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) recordedChunks.push(e.data);
                };

                mediaRecorder.onstart = () => {
                    audioStatus.textContent = "Enregistrement en cours…";
                    btnRecord.disabled = true;
                    btnStop.disabled = false;
                    btnSendAudio.disabled = true;
                };

                mediaRecorder.onstop = () => {
                    recordedBlob = new Blob(recordedChunks, { type: "audio/webm" });

                    audioPreview.src = URL.createObjectURL(recordedBlob);
                    audioPreview.style.display = "block";

                    audioStatus.textContent = "Enregistrement terminé.";
                    btnRecord.disabled = false;
                    btnStop.disabled = true;
                    btnSendAudio.disabled = false;

                    // Arrêter le micro
                    mediaStream.getTracks().forEach(t => t.stop());
                    mediaStream = null;
                };

                mediaRecorder.start();

            } catch (err) {
                audioStatus.textContent = "Erreur micro : " + err.message;
            }
        });

        btnStop.addEventListener("click", () => {
            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
            }
        });


        // ########################################
        // Fonction API POST FormData
        // ########################################

        async function apiPostForm(endpoint, formData) {
            const url = `${baseURL}${endpoint}?key_identity=${key_identity}&key_credential=${key_credential}`;

            const res = await fetch(url, {
                method: "POST",
                body: formData
            });

            if (!res.ok) {
                const errText = await res.text();
                throw new Error("HTTP " + res.status + " : " + errText);
            }

            return res.json();
        }


        // ########################################
        // Ajout d’un item + média dans Omeka S
        // ########################################

        btnSendAudio.addEventListener("click", async () => {
            if (!recordedBlob) {
                alert("Aucun audio enregistré.");
                return;
            }

            const nom = inputNom.value.trim();
            if (!nom) {
                alert("Donne un nom pour l’enregistrement.");
                return;
            }

            btnSendAudio.disabled = true;
            audioStatus.textContent = "Envoi en cours…";

            try {
                // Étape 1 : créer un item
                const itemData = {
                    "o:is_public": true,
                    "dcterms:title": [
                        { "type": "literal", "@value": nom }
                    ]
                };

                const createdItem = await fetch(
                    `${baseURL}/items?key_identity=${key_identity}&key_credential=${key_credential}`,
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(itemData)
                    }
                ).then(r => {
                    if (!r.ok) return r.text().then(t => { throw new Error(t); });
                    return r.json();
                });

                const itemId = createdItem["o:id"];

                // Étape 2 : créer un File à partir du blob
                const file = new File(
                    [recordedBlob],
                    nom.replace(/\s+/g, "_") + ".webm",
                    { type: recordedBlob.type || "audio/webm" }
                );

                // Étape 3 : créer le média (exact comme ta camarade)
                const mediaData = {
                    "o:item": { "o:id": Number(itemId) },
                    "o:ingester": "upload",
                    "file_index": 0,
                    "o:is_public": true
                };

                const fd = new FormData();
                fd.append("data", JSON.stringify(mediaData));
                fd.append("file[0]", file);

                const createdMedia = await apiPostForm("/media", fd);

                audioStatus.textContent = "Audio envoyé avec succès.";
                document.getElementById("responseAudio").textContent =
                    JSON.stringify({
                        item: createdItem,
                        media: createdMedia
                    }, null, 2);

            } catch (err) {
                audioStatus.textContent = "Erreur : " + err.message;
            } finally {
                btnSendAudio.disabled = false;
            }
        });
    </script>

    <!-- JS Bootstrap Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>